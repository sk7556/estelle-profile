<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Log - Bracer Guild</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --paper-bg: #fdfaf5;
            --ink-color: #2c2c2c;
            --accent-red: #c0392b;
            --accent-green: #27ae60;
            --accent-blue: #2980b9;
            --border-color: #8d6e63;
        }

        @font-face {
            font-family: 'Crimson Text';
            font-style: normal;
            font-weight: 400;
            src: local('Crimson Text Regular'), local('CrimsonText-Regular'), url(https://fonts.gstatic.com/s/crimsontext/v13/wlp2gwHKFkZgtmSR3NB0oRJfbwhT.woff2) format('woff2');
        }

        body {
            font-family: 'Crimson Text', 'Gowun Batang', 'Batang', serif;
            background-color: #e0dcd5;
            color: var(--ink-color);
            margin: 0;
            min-height: 100vh;
            background-image: radial-gradient(#d7ccc8 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* --- Navigation Bar --- */
        nav {
            background-color: #2c3e50;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .nav-brand {
            font-weight: bold;
            font-size: 1.2rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #ecf0f1;
            text-decoration: none;
        }

        .nav-links {
            display: flex;
            gap: 1.5rem;
        }

        .nav-links a {
            color: #bdc3c7;
            text-decoration: none;
            font-size: 0.95rem;
            transition: color 0.2s;
        }

        .nav-links a:hover, .nav-links a.active {
            color: white;
            font-weight: bold;
        }

        /* --- Main Layout --- */
        .container {
            max-width: 1400px; /* ë„“ì€ í™”ë©´ ëŒ€ì‘ */
            margin: 2rem auto;
            display: grid;
            grid-template-columns: 1fr 1fr; /* 2ë‹¨ ë ˆì´ì•„ì›ƒ */
            gap: 2rem;
            padding: 0 2rem;
        }

        @media (max-width: 900px) {
            .container {
                grid-template-columns: 1fr; /* ëª¨ë°”ì¼ì€ 1ë‹¨ */
            }
        }

        .panel {
            background-color: var(--paper-bg);
            padding: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 1px solid #d7ccc8;
            border-radius: 8px;
            height: fit-content;
        }

        h2 {
            margin-top: 0;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
            color: #5d4037;
        }

        /* Form Styling */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        label {
            display: block;
            font-weight: bold;
            font-size: 0.9rem;
            margin-bottom: 0.3rem;
            color: #5d4037;
        }

        input, textarea {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: inherit;
            box-sizing: border-box;
            font-size: 1rem;
        }

        button.primary {
            background-color: var(--accent-blue);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            font-size: 1rem;
            cursor: pointer;
            border-radius: 4px;
            font-weight: bold;
            width: 100%;
            margin-top: 1rem;
        }

        button.primary:hover {
            background-color: #1a5276;
        }

        /* Logs List */
        .logs-list {
            list-style: none;
            padding: 0;
            max-height: 600px;
            overflow-y: auto;
        }

        .log-card {
            background-color: #fff;
            border-left: 4px solid var(--accent-green);
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            position: relative;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            color: #888;
        }

        .log-condition {
            font-weight: bold;
            color: var(--accent-green);
        }

        /* AI Section */
        .ai-result {
            background-color: #e8f6f3;
            border: 1px solid #a2d9ce;
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1.5rem;
        }

        .loader {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid #ccc;
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s infinite linear;
            margin-right: 0.5rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .api-key-box {
            background: #fff3e0;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1.5rem;
            border: 1px solid #ffe0b2;
        }
    </style>
</head>
<body>

<!-- Navigation -->
<nav>
    <a href="index.html" class="nav-brand">ğŸ›¡ï¸ Bracer Guild</a>
    <div class="nav-links">
        <a href="index.html">Main</a>
        <a href="profile.html">Profile</a>
        <a href="health.html" class="active">Health Log</a>
    </div>
</nav>

<div id="app" class="container">
    
    <!-- Left Panel: Input & Consultation -->
    <div class="panel">
        <h2>ğŸ“ ê¸°ë¡ ì‘ì„± & ìƒë‹´ (Entry & Consult)</h2>
        
        <!-- API Key Check -->
        <div v-if="!apiKey" class="api-key-box">
            <label>ğŸ”‘ Gemini API Key ì„¤ì • (ìµœì´ˆ 1íšŒ)</label>
            <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                <input type="password" v-model="tempApiKey" placeholder="API Key ì…ë ¥...">
                <button @click="saveApiKey" style="width: auto; margin:0; padding: 0.5rem 1rem;">ì €ì¥</button>
            </div>
        </div>

        <!-- Input Form -->
        <div class="form-grid">
            <div>
                <label>ë‚ ì§œ (Date)</label>
                <input type="date" v-model="newLog.date">
            </div>
            <div>
                <label>ì»¨ë””ì…˜ (1-10)</label>
                <input type="number" min="1" max="10" v-model="newLog.condition">
            </div>
        </div>
        <div style="margin-bottom: 1rem;">
            <label>ì¦ìƒ ë° ì‹ë‹¨ (Details)</label>
            <textarea v-model="newLog.note" rows="5" placeholder="ì˜¤ëŠ˜ ë¨¹ì€ ìŒì‹, ìš´ë™ëŸ‰, ê¸°ë¶„ ë“±ì„ ììœ ë¡­ê²Œ ì ì–´ì£¼ì„¸ìš”."></textarea>
        </div>
        <button @click="addLog" class="primary" style="background-color: #2c3e50;">ê¸°ë¡ ì €ì¥ (Save Log)</button>

        <hr style="margin: 2rem 0; border: 0; border-top: 1px dashed #ccc;">

        <!-- AI Consult -->
        <button @click="consultAI" class="primary" style="background-color: var(--accent-red);" :disabled="isLoading || !apiKey">
            <span v-if="isLoading"><div class="loader"></div> ë¶„ì„ ì¤‘...</span>
            <span v-else>ğŸ¤– AI ì˜ë£Œ ìƒë‹´ ìš”ì²­ (Consult Gemini)</span>
        </button>

        <!-- AI Result -->
        <div v-if="aiResponse" class="ai-result">
            <h3 style="margin-top: 0; color: #16a085;">ğŸ“‹ Dr. Geminiì˜ ì†Œê²¬</h3>
            <div v-html="parsedAiResponse" style="line-height: 1.6; font-size: 0.95rem;"></div>
        </div>
    </div>

    <!-- Right Panel: History -->
    <div class="panel">
        <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; margin-bottom: 1rem;">
            <h2 style="border: none; margin: 0; padding: 0;">ğŸ—‚ï¸ ê¸°ë¡ ë³´ê´€ì†Œ (History)</h2>
            <button @click="clearApiKey" style="font-size: 0.8rem; background: none; border: 1px solid #ccc; padding: 0.2rem 0.5rem; cursor: pointer; color: #888;">API Key ì´ˆê¸°í™”</button>
        </div>

        <ul class="logs-list">
            <li v-for="(log, index) in sortedLogs" :key="index" class="log-card">
                <div class="log-header">
                    <span style="color: #333; font-weight: bold;">{{ log.date }}</span>
                    <span class="log-condition">ìƒíƒœ: {{ log.condition }}/10</span>
                </div>
                <div style="white-space: pre-wrap;">{{ log.note }}</div>
                <button @click="deleteLog(index)" style="position: absolute; top: 1rem; right: 1rem; border: none; background: none; color: #e74c3c; cursor: pointer;">ì‚­ì œ</button>
            </li>
            <li v-if="logs.length === 0" style="text-align: center; color: #aaa; padding: 3rem;">
                ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.<br>ì™¼ìª½ì—ì„œ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.
            </li>
        </ul>
    </div>

</div>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                apiKey: '',
                tempApiKey: '',
                logs: [],
                newLog: {
                    date: new Date().toISOString().split('T')[0],
                    condition: 8,
                    note: ''
                },
                aiResponse: '',
                isLoading: false
            }
        },
        computed: {
            sortedLogs() {
                return [...this.logs].sort((a, b) => new Date(b.date) - new Date(a.date));
            },
            parsedAiResponse() {
                return this.aiResponse ? marked.parse(this.aiResponse) : '';
            }
        },
        mounted() {
            const savedLogs = localStorage.getItem('bracer_health_logs');
            if (savedLogs) this.logs = JSON.parse(savedLogs);
            
            const savedKey = localStorage.getItem('bracer_api_key');
            if (savedKey) this.apiKey = savedKey;
        },
        methods: {
            saveApiKey() {
                if (this.tempApiKey.trim()) {
                    this.apiKey = this.tempApiKey.trim();
                    localStorage.setItem('bracer_api_key', this.apiKey);
                    this.tempApiKey = '';
                    alert('API Key ì €ì¥ ì™„ë£Œ!');
                }
            },
            clearApiKey() {
                if(confirm('API Keyë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    this.apiKey = '';
                    localStorage.removeItem('bracer_api_key');
                }
            },
            addLog() {
                if (!this.newLog.note.trim()) return alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                this.logs.unshift({ ...this.newLog });
                this.saveLogs();
                this.newLog.note = '';
                this.newLog.condition = 8;
            },
            deleteLog(index) {
                if (confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    this.logs.splice(index, 1);
                    this.saveLogs();
                }
            },
            saveLogs() {
                localStorage.setItem('bracer_health_logs', JSON.stringify(this.logs));
            },
            async consultAI() {
                if (!this.apiKey) return alert('API Keyê°€ í•„ìš”í•©ë‹ˆë‹¤.');
                
                this.isLoading = true;
                this.aiResponse = '';

                // ìµœê·¼ 7ê°œ ê¸°ë¡ ë¶„ì„
                const recentLogs = this.logs.slice(0, 7);
                const context = `
                    ë‹¹ì‹ ì€ ìœ ê²©ì‚¬ í˜‘íšŒì˜ ì „ë¬¸ ì˜ë£Œ ìƒë‹´ê´€ì…ë‹ˆë‹¤. 
                    ì‚¬ìš©ì(ì •ì‹)ì˜ ê±´ê°• ê¸°ë¡ì„ ë¶„ì„í•˜ì—¬ ì˜ì–‘, ìš´ë™, íœ´ì‹ ì¸¡ë©´ì—ì„œ êµ¬ì²´ì ì¸ ì¡°ì–¸ì„ í•´ì£¼ì„¸ìš”.
                    
                    [ìµœê·¼ ê¸°ë¡]
                    ${JSON.stringify(recentLogs, null, 2)}
                    
                    ë‹µë³€ì€ Markdown í˜•ì‹ìœ¼ë¡œ ê¹”ë”í•˜ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”.
                `;

                try {
                    // Model: gemini-1.5-flash-latest ì‚¬ìš© (ì•ˆì •ì„± í™•ë³´)
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${this.apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: context }] }]
                        })
                    });
                    
                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error(errData.error?.message || 'API Error');
                    }

                    const data = await response.json();
                    if (data.candidates && data.candidates[0].content) {
                        this.aiResponse = data.candidates[0].content.parts[0].text;
                    }
                } catch (error) {
                    console.error(error);
                    alert('ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
                } finally {
                    this.isLoading = false;
                }
            }
        }
    }).mount('#app');
</script>

</body>
</html>
