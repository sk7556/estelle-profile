<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Log - Bracer Guild</title>
    <!-- Vue.js CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Marked for Markdown Parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --paper-bg: #fdfaf5;
            --ink-color: #2c2c2c;
            --accent-red: #c0392b;
            --accent-green: #27ae60;
            --accent-blue: #2980b9;
            --border-color: #8d6e63;
        }

        @font-face {
            font-family: 'Crimson Text';
            font-style: normal;
            font-weight: 400;
            src: local('Crimson Text Regular'), local('CrimsonText-Regular'), url(https://fonts.gstatic.com/s/crimsontext/v13/wlp2gwHKFkZgtmSR3NB0oRJfbwhT.woff2) format('woff2');
        }

        body {
            font-family: 'Crimson Text', 'Gowun Batang', 'Batang', serif;
            background-color: #e0dcd5;
            color: var(--ink-color);
            margin: 0;
            padding: 2rem;
            min-height: 100vh;
            background-image: radial-gradient(#d7ccc8 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: var(--paper-bg);
            padding: 3rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 1px solid #d7ccc8;
            min-height: 80vh;
        }

        header {
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            margin: 0;
            font-size: 1.8rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--ink-color);
        }

        .back-btn {
            text-decoration: none;
            color: var(--border-color);
            font-weight: bold;
            font-size: 0.9rem;
            border: 1px solid var(--border-color);
            padding: 0.3rem 0.8rem;
            border-radius: 4px;
        }

        /* Form Styling */
        .log-entry-form {
            background-color: #fff;
            padding: 1.5rem;
            border: 1px dashed var(--border-color);
            margin-bottom: 2rem;
            border-radius: 4px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        label {
            display: block;
            font-weight: bold;
            font-size: 0.9rem;
            margin-bottom: 0.3rem;
            color: #5d4037;
        }

        input, select, textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: inherit;
            box-sizing: border-box;
        }

        button.primary {
            background-color: var(--accent-blue);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            font-size: 1rem;
            cursor: pointer;
            border-radius: 4px;
            font-weight: bold;
            transition: background 0.2s;
        }

        button.primary:hover {
            background-color: #1a5276;
        }

        button.secondary {
            background-color: #95a5a6;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-radius: 4px;
        }

        /* Logs List */
        .logs-list {
            list-style: none;
            padding: 0;
        }

        .log-card {
            background-color: #fff;
            border-left: 4px solid var(--accent-green);
            padding: 1rem 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: relative;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: #888;
        }

        .log-date {
            font-weight: bold;
            color: var(--ink-color);
        }

        .log-condition {
            font-weight: bold;
            color: var(--accent-green);
        }

        .log-content {
            font-size: 1rem;
            line-height: 1.5;
        }

        /* AI Analysis Section */
        .ai-section {
            margin-top: 3rem;
            border-top: 2px double var(--border-color);
            padding-top: 2rem;
        }

        .ai-card {
            background-color: #f0f8ff;
            border: 1px solid #b3e5fc;
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .ai-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            color: var(--accent-blue);
            font-weight: bold;
        }

        .loader {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid #ccc;
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s infinite linear;
            margin-right: 0.5rem;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .api-key-input {
            margin-bottom: 1rem;
            padding: 1rem;
            background: #fff3e0;
            border: 1px solid #ffe0b2;
            border-radius: 4px;
        }

    </style>
</head>
<body>

<div id="app" class="container">
    <header>
        <div>
            <h1>ğŸ¥ Medical Log (ì˜ë¬´ ê¸°ë¡)</h1>
            <div style="font-size: 0.9rem; color: #795548;">Guild Member: JungSik / Authorized by: Estelle</div>
        </div>
        <a href="index.html" class="back-btn">â† Main Menu</a>
    </header>

    <!-- API Key Input (if not set) -->
    <div v-if="!apiKey" class="api-key-input">
        <label>ğŸ”‘ Gemini API Key í•„ìš” (ì €ì¥ë˜ì§€ ì•ŠìŒ)</label>
        <div style="display: flex; gap: 0.5rem;">
            <input type="password" v-model="tempApiKey" placeholder="Paste your API Key here...">
            <button @click="saveApiKey" class="secondary">í™•ì¸</button>
        </div>
        <small style="color: #666;">* ë¸Œë¼ìš°ì € ì„¸ì…˜ ë™ì•ˆë§Œ ìœ ì§€ë©ë‹ˆë‹¤.</small>
    </div>

    <!-- New Log Form -->
    <section class="log-entry-form">
        <h3 style="margin-top: 0;">ğŸ“ ìƒˆë¡œìš´ ê¸°ë¡ ì‘ì„±</h3>
        <div class="form-grid">
            <div>
                <label>ë‚ ì§œ (Date)</label>
                <input type="date" v-model="newLog.date">
            </div>
            <div>
                <label>ì»¨ë””ì…˜ (1-10)</label>
                <input type="number" min="1" max="10" v-model="newLog.condition">
            </div>
        </div>
        <div style="margin-bottom: 1rem;">
            <label>ì¦ìƒ ë° íŠ¹ì´ì‚¬í•­ (Symptoms & Notes)</label>
            <textarea v-model="newLog.note" rows="3" placeholder="ì˜ˆ: ë¨¸ë¦¬ê°€ ì¢€ ì•„í”„ê³  í”¼ê³¤í•¨. ì–´ì œ ëŠ¦ê²Œ ì ."></textarea>
        </div>
        <div style="text-align: right;">
            <button @click="addLog" class="primary">ê¸°ë¡ ì €ì¥ (Save)</button>
        </div>
    </section>

    <!-- AI Consultation Button -->
    <div style="text-align: center; margin-bottom: 2rem;">
        <button @click="consultAI" class="primary" style="background-color: var(--accent-red);" :disabled="logs.length === 0 || !apiKey">
            ğŸ¤– Gemini ì˜ë£Œ ìƒë‹´ ìš”ì²­ (Consult AI)
        </button>
        <div v-if="!apiKey" style="margin-top: 0.5rem; font-size: 0.8rem; color: red;">* ìƒë‹´í•˜ë ¤ë©´ ìœ„ì—ì„œ API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</div>
    </div>

    <!-- AI Analysis Result -->
    <section v-if="aiResponse" class="ai-section">
        <h3>ğŸ“‹ AI ìƒë‹´ ë¦¬í¬íŠ¸</h3>
        <div class="ai-card">
            <div class="ai-header">
                <span>ğŸ¤– Dr. Gemini's Diagnosis</span>
            </div>
            <div v-html="parsedAiResponse" style="line-height: 1.6;"></div>
        </div>
    </section>

    <section v-if="isLoading" class="ai-section" style="text-align: center; color: #666;">
        <div class="loader"></div> ìƒë‹´ ë‚´ìš©ì„ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...
    </section>

    <!-- Past Logs -->
    <section>
        <h3>ğŸ—‚ï¸ ì§€ë‚œ ê¸°ë¡ (History)</h3>
        <ul class="logs-list">
            <li v-for="(log, index) in sortedLogs" :key="index" class="log-card">
                <div class="log-header">
                    <span class="log-date">{{ log.date }}</span>
                    <span class="log-condition">Condition: {{ log.condition }}/10</span>
                </div>
                <div class="log-content">{{ log.note }}</div>
                <button @click="deleteLog(index)" style="position: absolute; top: 1rem; right: 1rem; border: none; background: none; color: #aaa; cursor: pointer;">Ã—</button>
            </li>
            <li v-if="logs.length === 0" style="text-align: center; color: #aaa; padding: 2rem;">
                ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.
            </li>
        </ul>
    </section>
</div>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                apiKey: '',
                tempApiKey: '',
                logs: [],
                newLog: {
                    date: new Date().toISOString().split('T')[0],
                    condition: 8,
                    note: ''
                },
                aiResponse: '',
                isLoading: false
            }
        },
        computed: {
            sortedLogs() {
                return [...this.logs].sort((a, b) => new Date(b.date) - new Date(a.date));
            },
            parsedAiResponse() {
                return this.aiResponse ? marked.parse(this.aiResponse) : '';
            }
        },
        mounted() {
            // Load logs
            const savedLogs = localStorage.getItem('bracer_health_logs');
            if (savedLogs) {
                this.logs = JSON.parse(savedLogs);
            }
            
            // Load API Key safely
            const savedKey = localStorage.getItem('bracer_api_key');
            if (savedKey) {
                this.apiKey = savedKey;
            }
        },
        methods: {
            saveApiKey() {
                if (this.tempApiKey.trim()) {
                    this.apiKey = this.tempApiKey.trim();
                    localStorage.setItem('bracer_api_key', this.apiKey); // Save to browser
                    this.tempApiKey = '';
                    alert('API í‚¤ê°€ ë¸Œë¼ìš°ì €ì— ì•ˆì „í•˜ê²Œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ì´ì œ ë‹¤ì‹œ ì…ë ¥í•  í•„ìš” ì—†ìŠµë‹ˆë‹¤.');
                }
            },
            clearApiKey() {
                this.apiKey = '';
                localStorage.removeItem('bracer_api_key');
                alert('API í‚¤ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            },
            addLog() {
                if (!this.newLog.note.trim()) {
                    alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                this.logs.unshift({ ...this.newLog }); // Add to top
                this.saveLogs();
                this.newLog.note = ''; // Reset note
                this.newLog.condition = 8; // Reset condition
            },
            deleteLog(index) {
                if (confirm('ì´ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    this.logs.splice(index, 1);
                    this.saveLogs();
                }
            },
            saveLogs() {
                localStorage.setItem('bracer_health_logs', JSON.stringify(this.logs));
            },
            async consultAI() {
                if (!this.apiKey) return alert('API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
                
                this.isLoading = true;
                this.aiResponse = '';

                // Prepare context for AI
                const recentLogs = this.logs.slice(0, 5); // Recent 5 logs
                const context = `
                    ë‹¹ì‹ ì€ ìœ ê²©ì‚¬ í˜‘íšŒì˜ ìˆ™ë ¨ëœ ì˜ë£Œ ë‹´ë‹¹ê´€ì´ì ìƒë‹´ì‚¬ì…ë‹ˆë‹¤.
                    ì‚¬ìš©ì(ì •ì‹)ì˜ ìµœê·¼ ê±´ê°• ê¸°ë¡ì„ ë°”íƒ•ìœ¼ë¡œ ê±´ê°• ìƒíƒœë¥¼ ë¶„ì„í•˜ê³ , 
                    ë”°ëœ»í•˜ê³  ì „ë¬¸ì ì¸ ì¡°ì–¸ì„ í•´ì£¼ì„¸ìš”. (í•œêµ­ì–´ë¡œ ë‹µë³€)
                    
                    [ìµœê·¼ ê¸°ë¡]
                    ${JSON.stringify(recentLogs, null, 2)}
                `;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${this.apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: context }] }]
                        })
                    });
                    
                    const data = await response.json();
                    if (data.candidates && data.candidates[0].content) {
                        this.aiResponse = data.candidates[0].content.parts[0].text;
                    } else {
                        throw new Error('API ì‘ë‹µ ì˜¤ë¥˜');
                    }
                } catch (error) {
                    console.error(error);
                    alert('AI ìƒë‹´ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. API í‚¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
                } finally {
                    this.isLoading = false;
                }
            }
        }
    }).mount('#app');
</script>

</body>
</html>
