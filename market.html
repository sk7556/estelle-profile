<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—ìŠ¤í…”ì˜ ë§Œë¬¼ìƒ (Estelle's General Store)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Tailwind CSS (Using script just for CDN warning suppression in dev, but still CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {},
            },
        }
    </script>
    <style>
        /* Suppress Tailwind CDN warning in console */
        /* Note: This is a hack, real fix requires build step or ignoring console warn */
        @import url('https://fonts.googleapis.com/css2?family=Gowun+Batang:wght@400;700&display=swap');

        body {
            font-family: 'Gowun Batang', serif;
            background-color: #fdfaf5;
            background-image: radial-gradient(#d7ccc8 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .wood-frame {
            background: #8d6e63;
            border: 4px solid #5d4037;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.3);
            border-radius: 8px;
        }

        .shelf-bg {
            background: #d7ccc8;
            background-image: linear-gradient(to bottom, transparent 95%, rgba(0,0,0,0.1) 95%);
            background-size: 100% 20px;
        }

        .item-card {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            overflow: hidden;
        }

        .item-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            z-index: 10;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #c0392b;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Polaroid Effect */
        .polaroid {
            background: #fff;
            padding: 10px 10px 25px 10px;
            box-shadow: 2px 3px 5px rgba(0,0,0,0.15);
            transform: rotate(var(--rotation));
        }

        .nav-link {
            transition: color 0.2s;
        }
        .nav-link:hover {
            color: #fff;
            font-weight: bold;
        }
    </style>
</head>
<body class="text-[#2c2c2c]">

    <div id="app" class="min-h-screen flex flex-col">
        <!-- Navigation -->
        <nav class="bg-[#2c3e50] text-white p-4 shadow-md fixed w-full z-50">
            <div class="container mx-auto flex justify-between items-center">
                <a href="index.html" class="font-bold text-xl tracking-wider hover:text-[#ecf0f1]">ğŸ›¡ï¸ Bracer Guild</a>
                <div class="space-x-6 text-sm">
                    <a href="index.html" class="nav-link text-gray-300">Main</a>
                    <a href="profile.html" class="nav-link text-gray-300">Profile</a>
                    <a href="health.html" class="nav-link text-gray-300">Health Log</a>
                    <a href="#" class="nav-link text-white font-bold border-b-2 border-white pb-1">General Store</a>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="flex-grow container mx-auto pt-24 pb-12 px-4">
            
            <!-- Header -->
            <div class="text-center mb-10">
                <div class="inline-block bg-[#c0392b] text-white px-4 py-1 rounded-full text-sm font-bold mb-2 shadow-sm">NEW OPEN!</div>
                <h1 class="text-4xl font-bold text-[#5d4037] mb-2">ğŸ“¦ ì—ìŠ¤í…”ì˜ ë§Œë¬¼ìƒ</h1>
                <p class="text-[#795548] italic">"ë­ë“ ì§€ êµ¬í•´ë‹¤ ì¤„ê²Œ! ë§ë§Œ í•´!"</p>
            </div>

            <!-- Input Area -->
            <div class="max-w-xl mx-auto mb-12 relative">
                <div class="flex shadow-lg rounded-lg overflow-hidden border-2 border-[#8d6e63]">
                    <input 
                        v-model="searchKeyword" 
                        @keyup.enter="searchImage"
                        type="text" 
                        placeholder="ê°€íŒëŒ€ì— ì˜¬ë¦´ ë¬¼ê±´ì„ ì…ë ¥í•´ (ì˜ˆ: ë§›ìˆëŠ” ë¼ë©´)" 
                        class="flex-grow px-6 py-4 text-lg focus:outline-none bg-[#fffaf0] placeholder-[#a1887f]"
                        :disabled="isLoading"
                    >
                    <button 
                        @click="searchImage" 
                        class="bg-[#8d6e63] hover:bg-[#6d4c41] text-white px-8 py-2 font-bold transition-colors flex items-center justify-center min-w-[100px]"
                        :disabled="isLoading"
                    >
                        <div v-if="isLoading" class="loading-spinner w-6 h-6 border-2"></div>
                        <span v-else>êµ¬í•˜ê¸°!</span>
                    </button>
                </div>
                <!-- API Key Config Toggle -->
                <button @click="showConfig = !showConfig" class="absolute -bottom-8 right-0 text-xs text-[#8d6e63] underline hover:text-[#5d4037] flex items-center">
                    <span v-if="hfToken" class="mr-1 text-green-600 font-bold">âœ… HF í† í° ì…ë ¥ë¨</span>
                    âš™ï¸ ê²€ìƒ‰ ì„¤ì • (API Key)
                </button>
            </div>

            <!-- Clear All Button -->
            <div class="fixed bottom-4 left-4 z-50">
                <button @click="clearAllItems" class="bg-red-500 hover:bg-red-600 text-white text-xs px-3 py-1 rounded shadow opacity-80 hover:opacity-100 transition-opacity">
                    ğŸ—‘ï¸ ì „ì²´ ì´ˆê¸°í™”
                </button>
            </div>

            <!-- Config Panel (Hidden by default) -->
            <div v-if="showConfig" class="max-w-xl mx-auto mb-8 p-4 bg-white border border-[#d7ccc8] rounded shadow-inner text-sm">
                <h3 class="font-bold mb-2">ğŸ”§ ì„¤ì • (Configuration)</h3>
                
                <div class="mb-4">
                    <label class="block text-xs font-bold text-[#5d4037] mb-1">Hugging Face Token (ì¶”ì²œ! ğŸ†)</label>
                    <p class="text-xs text-gray-500 mb-1">ê³ í€„ë¦¬í‹° ì• ë‹ˆë©”ì´ì…˜ ê·¸ë¦¼ì„ ì›í•˜ë©´ í† í°ì„ ë„£ì–´ì¤˜! (ë¬´ë£Œ)</p>
                    <input v-model="hfToken" type="password" placeholder="hf_..." class="border p-2 rounded w-full mb-1">
                    <p class="text-[10px] text-[#c0392b]" v-if="!hfToken">â€» í† í°ì´ ì—†ìœ¼ë©´ ë¶ˆì•ˆì •í•œ ë¬´ë£Œ AIë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.</p>
                </div>

                <hr class="border-t border-gray-200 my-3">

                <div class="mb-2 opacity-50 hover:opacity-100 transition-opacity">
                    <label class="block text-xs font-bold text-gray-500 mb-1">Google Search (ì„ íƒì‚¬í•­)</label>
                    <div class="grid gap-2">
                        <input v-model="apiKey" type="password" placeholder="Google API Key" class="border p-2 rounded">
                        <input v-model="searchEngineId" type="text" placeholder="Search Engine ID (CX)" class="border p-2 rounded">
                    </div>
                </div>

                <button @click="saveConfig" class="bg-[#2c3e50] text-white w-full py-2 rounded hover:bg-[#34495e] mt-2 font-bold">ì„¤ì • ì €ì¥í•˜ê¸°</button>
            </div>

            <!-- The Stall (Grid) -->
            <div class="wood-frame p-6 min-h-[600px] bg-[#e0dcd5] relative">
                <!-- Roof pattern -->
                <div class="absolute -top-4 left-0 w-full h-4 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMCAxMCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSI+PHBhdGggZD0iTTAgMTAgTDEwIDAgTDIwIDEwIFoiIGZpbGw9IiNjMDM5MmIiLz48L3N2Zz4=')] bg-repeat-x bg-contain"></div>

                <div v-if="items.length === 0" class="h-full flex flex-col items-center justify-center text-[#8d6e63] opacity-50 min-h-[500px]">
                    <span class="text-6xl mb-4">ğŸ•¸ï¸</span>
                    <p>ê°€íŒëŒ€ê°€ ë¹„ì–´ìˆì–´! ë­”ê°€ ì£¼ë¬¸í•´ë³¼ë˜?</p>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-6 p-4">
                    <div v-for="(item, index) in items" :key="item.id" 
                         class="item-card polaroid"
                         :style="{ '--rotation': item.rotation + 'deg' }">
                        <div class="aspect-square bg-gray-100 mb-3 overflow-hidden border border-gray-200 flex items-center justify-center bg-cover bg-center"
                             :style="{ backgroundImage: `url(${item.url})` }">
                            <!-- Image handled by background-image for better fitting, but keeping img for accessibility if needed, hidden -->
                            <img :src="item.url" :alt="item.keyword" class="opacity-0 w-full h-full" @error="handleImageError(index)">
                        </div>
                        <div class="text-center">
                            <div class="font-bold text-[#2c2c2c] truncate">{{ item.keyword }}</div>
                            <div class="text-xs text-gray-500">{{ item.date }}</div>
                        </div>
                        <!-- Delete button (visible on hover) -->
                        <button @click="removeItem(index)" class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity text-xs">
                            Ã—
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="text-center mt-4 text-xs text-[#8d6e63]">
                * ìµœëŒ€ 16ê°œê¹Œì§€ë§Œ ì§„ì—´ë©ë‹ˆë‹¤. (ì˜¤ë˜ëœ ë¬¼ê±´ì€ ì°½ê³ ë¡œ ê°€ìš”!)
            </div>

        </main>
    </div>

    <script>
        const { createApp, ref, onMounted } = Vue

        createApp({
            setup() {
                const searchKeyword = ref('')
                const items = ref([])
                const isLoading = ref(false)
                const showConfig = ref(false)
                
                // Config
                const apiKey = ref('')
                const searchEngineId = ref('')
                const hfToken = ref('')

                onMounted(() => {
                    // Load data from LocalStorage
                    const savedItems = localStorage.getItem('estelle_store_items')
                    if (savedItems) items.value = JSON.parse(savedItems)

                    const savedKey = localStorage.getItem('google_api_key')
                    if (savedKey) apiKey.value = savedKey

                    const savedCx = localStorage.getItem('google_cx')
                    if (savedCx) searchEngineId.value = savedCx
                    
                    const savedHf = localStorage.getItem('hf_token')
                    if (savedHf) hfToken.value = savedHf
                })

                const saveConfig = () => {
                    localStorage.setItem('google_api_key', apiKey.value)
                    localStorage.setItem('google_cx', searchEngineId.value)
                    localStorage.setItem('hf_token', hfToken.value)
                    showConfig.value = false
                    alert('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆì–´! ì´ì œ ì—ìŠ¤í…”ì´ ë” ë˜‘ë˜‘í•´ì§ˆ ê±°ì•¼! âœ¨')
                }

                const searchImage = async () => {
                    const keyword = searchKeyword.value.trim()
                    if (!keyword) return

                    isLoading.value = true

                    try {
                        let imageUrl = ''
                        
                        // 0. Priority: Hugging Face (If token exists)
                        if (hfToken.value) {
                            try {
                                console.log("Trying Hugging Face generation...")
                                // Using Animagine XL 3.1 for best anime results
                                const response = await fetch(
                                    "https://api-inference.huggingface.co/models/cagliostro-research/animagine-xl-3.1",
                                    {
                                        headers: {
                                            Authorization: `Bearer ${hfToken.value}`,
                                            "Content-Type": "application/json",
                                        },
                                        method: "POST",
                                        body: JSON.stringify({ 
                                            inputs: `masterpiece, best quality, highly detailed, anime style, ${keyword}, vibrant colors, studio ghibli style, 8k wallpaper`,
                                            parameters: {
                                                negative_prompt: "lowres, bad anatomy, bad hands, text, error, missing fingers, extra digit, fewer digits, cropped, worst quality, low quality, normal quality, jpeg artifacts, signature, watermark, username, blurry"
                                            } 
                                        }),
                                    }
                                );
                                
                                if (!response.ok) {
                                    const errText = await response.text();
                                    throw new Error(`HF API Error: ${response.status} ${errText}`);
                                }
                                
                                const blob = await response.blob();
                                imageUrl = URL.createObjectURL(blob); // Create local URL for the blob
                                
                            } catch (e) {
                                console.error("Hugging Face failed:", e)
                                alert(`Hugging Face ìƒì„± ì‹¤íŒ¨!\nì›ì¸: ${e.message}\n(í† í°ì´ ì˜¬ë°”ë¥¸ì§€, í˜¹ì€ ëª¨ë¸ ë¡œë”© ì¤‘ì¸ì§€ í™•ì¸í•´ì¤˜!)`)
                                isLoading.value = false
                                return; // Stop here! Do not fallback.
                            }
                        }

                        // 1. Try Google Search if keys exist (and HF didn't run or failed)
                        else if (!imageUrl && apiKey.value && searchEngineId.value) {
                            try {
                                const response = await fetch(`https://www.googleapis.com/customsearch/v1?q=${encodeURIComponent(keyword)}&cx=${searchEngineId.value}&key=${apiKey.value}&searchType=image&num=1`)
                                const data = await response.json()
                                if (data.items && data.items.length > 0) {
                                    imageUrl = data.items[0].link
                                } else {
                                    throw new Error('No results from Google Search')
                                }
                            } catch (e) {
                                console.warn("Google Search Failed, trying fallback...", e)
                                
                                // Explicitly handle 403 (Service Not Enabled) or other API errors
                                // If Google fails, use Pollinations with Anime/Pixiv Style
                                const prompt = `anime style illustration of ${keyword}, pixiv style, high quality, masterpiece, 8k`
                                imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?width=400&height=400&nologo=true&seed=${Math.floor(Math.random() * 9999)}&model=flux`
                            }
                        } else {
                            // 2. Magic Mode (Pollinations.ai) - No key needed
                            const prompt = `anime style illustration of ${keyword}, pixiv style, high quality, masterpiece, 8k`
                            imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?width=400&height=400&nologo=true&seed=${Math.floor(Math.random() * 1000)}&model=flux`
                        }

                        addItem(keyword, imageUrl)
                        searchKeyword.value = '' // Clear input

                    } catch (error) {
                        alert('ì•—! ë¬¼ê±´ì„ êµ¬í•´ì˜¤ë‹¤ê°€ ë„˜ì–´ì¡Œì–´... ë‹¤ì‹œ ì‹œë„í•´ë³¼ë˜? ğŸ˜­')
                        console.error(error)
                    } finally {
                        isLoading.value = false
                    }
                }

                const addItem = (keyword, url) => {
                    const newItem = {
                        id: Date.now(),
                        keyword: keyword,
                        url: url,
                        date: new Date().toLocaleDateString(),
                        rotation: (Math.random() * 6) - 3 // Random rotation -3deg to 3deg
                    }

                    // Add to beginning (unshift)
                    items.value.unshift(newItem)

                    // Keep only 16 items
                    if (items.value.length > 16) {
                        items.value.pop()
                    }

                    saveItems()
                }

                const removeItem = (index) => {
                    items.value.splice(index, 1)
                    saveItems()
                }

                const saveItems = () => {
                    localStorage.setItem('estelle_store_items', JSON.stringify(items.value))
                }

                const handleImageError = (index) => {
                    const item = items.value[index]
                    
                    // Initialize retry count if not present
                    if (typeof item.retryCount === 'undefined') {
                        item.retryCount = 0
                    }

                    item.retryCount++

                    if (item.retryCount > 2) {
                        // Stop retrying after 2 failures and show a static placeholder
                        console.warn(`Giving up on image for ${item.keyword} after ${item.retryCount} tries.`)
                        // Use a reliable placeholder service
                        item.url = `https://placehold.co/400x400/efebe9/8d6e63?text=Load+Failed`
                        return
                    }

                    console.log(`Image load error for ${item.keyword}, retry #${item.retryCount}...`)
                    
                    // Retry Logic
                    if (item.retryCount === 1) {
                         // Retry 1: Try a specific Anime-tuned model prompt with Pollinations (Backup to HF)
                         // Wait, if HF failed, we shouldn't rely on it again if we want fallback.
                         // But if HF worked and returned a blob, it shouldn't error.
                         // This error handler catches Pollinations errors mostly.
                         const animePrompt = `(masterpiece), best quality, ${encodeURIComponent(item.keyword)}, anime style, makoto shinkai style, studio ghibli, vibrant lighting, highly detailed, 8k wallpaper`
                         item.url = `https://image.pollinations.ai/prompt/${animePrompt}?width=400&height=400&nologo=true&seed=${Math.floor(Math.random() * 9999)}&model=flux`
                    } else if (item.retryCount === 2) {
                         console.warn("Retrying with Pollinations Turbo model...")
                         item.url = `https://image.pollinations.ai/prompt/anime ${encodeURIComponent(item.keyword)}?width=400&height=400&nologo=true&model=turbo&seed=${Math.floor(Math.random() * 9999)}`
                    }
                }

                return {
                    searchKeyword,
                    items,
                    isLoading,
                    searchImage,
                    removeItem,
                    showConfig,
                    apiKey,
                    searchEngineId,
                    saveConfig,
                    handleImageError
                }
            }
        }).mount('#app')
    </script>
</body>
</html>
